\section{Background}

Urd is a transaction-log-based service keeping track of all jobs for
all users of a framework setup.

The idea is that each user of the framework has one or more locations
in the database where information about executed jobs are stored.
These locations are called urd-lists.  The lists are readable to
anyone, but due to authorisation only writeable by the owning user.


\section{Urd sessions}

begin ... finish.

begin options: path <timestamp> <caption> <update>
finish:        path; <timestamp> and <caption> overrides
abort()


\section{An example Urd session}

Consider the following example that dispatches method1, method2, and
method3 consecutively.

\begin{python}
def main(urd):
  urd.begin{'test')
  jid1 = urd.build('method1')
  jid2 = urd.build('method2', jobids=dict(firstjob=jid1)
  jid3 = urd.build('method3', jobids=dict(firstjob=jid1, secondjob=jid2)
  urd.finish('test', '20161025')
\end{python}

now, urd keeps a record of everything that has been build and its
dependencies.  A complete history of executed jobs is stored in the
joblist member, and can be printed pretty like this

\begin{python}
  print urd.joblist.pretty
# JobList(
#    [  0] method1 : test-56_0
#    [  1] method2 : test-57_0
#    [  2] method3 : test-58_0
# )
\end{python}

\begin{python}
  print urd.peek_latest('test')
# {'caption': '',
#  'automata': 'test',
#  'user': 'ab',
#  'deps': {},
#  'timestamp': '20161025',
#  'joblist': JobList([
#     ('method1', 'test-56_0'),
#     ('method2', 'test-59_0'),
#     ('method3', 'test-60_0')
#  ])
# }
\end{python}
\begin{python}
  # and another peek
  print urd.peek_first('test')

  # and another
  print urd.peek('test', '20161026')

  # and another
  print urd.since('test', '20161026')
\end{python}



this can also be achieved by

\begin{shell}
% curl http://localhost:8833/list
["ab/test"]

% curl http://localhost:8833/ab/test/latest
{"caption": "", "automata": "test", "user": "ab", "deps": {},
  "timestamp": "20161025", "joblist": [["method1", "test-56_0"],
  ["method2", "test-59_0"], ["method3", "test-60_0"]]}

% curl http://localhost:8833/ab/test/first
{"caption": "", "automata": "test", "user": "ab", "deps": {},
  "timestamp": "20161025", "joblist": [["method1", "test-56_0"],
  ["method2", "test-59_0"], ["method3", "test-60_0"]]}

% curl http://localhost:8833/ab/test/20161025              (git)-[99b6358...] 
{"caption": "", "automata": "test", "user": "ab", "deps": {},
  "timestamp": "20161025", "joblist": [["method1", "test-56_0"],
  ["method2", "test-59_0"], ["method3", "test-60_0"]]}

% curl http://localhost:8833/ab/test/since/201610024
["20161025"]

% curl http://localhost:8833/ab/test/since/20161026
[]                                 

\end{shell}


% x peek
% x peek\_latest
% x peek\_first
% x since
% x begin
% x abort
% x finish
% x build
% truncate
% get
% latest
% first
% build\_chained


% x @route('/<user>/<automata>/since/<timestamp>')
% x @route('/<user>/<automata>/latest')
% x @route('/<user>/<automata>/first')
% x @route('/<user>/<automata>/<timestamp>')
% x @route('/list')
% @route('/add', method='POST')
% @route('/truncate/<user>/<automata>/<timestamp>', method='POST')








\section{Jobtuple and Joblist}

A simple automata starts with defining the function main that takes an
urd object as input

this automata will execute the two methods method1 and method2
consecutively.  Urd will store links to the completed jobs in a
joblist object, accessible by




The jobtuple is a datatype used for storing pairs of names and jobids.
A user typically never creates these, but rather use
\begin{python}

\end{python}


.pretty
.jobid
.method


\section{api}
Example

\begin{python}
def main(urd):
  latest = urd.latest('ab/neu4')
  print latest
#{
#  'user': 'ab',
#  'automata': 'neu4',
#  'caption': '',
#  'timestamp': '53910101',
#  'joblist': JobList(
#    [
#      ('import_amit', 'neu4-1820_0')
#    ]
#  )
#  'deps': {
#    'ab/neu2': {
#      'caption': 'raw_repository_5391.gz',
#      'timestamp': '53910101'
#      'joblist': JobList(
#        [
#          ('import', 'neu-14679_0'),
#          ('typed', 'neu-14680_0'),
#          ('addcolumns', 'neu2-4893_0')
#        ]
#      ),
#    }
#  },
#}
\end{python}
so the jobid is found by

\begin{python}
  jid = latest.joblist.jobid

  urd.build('my_method',
    datasets = dict(source=jid),
    options = dict(length=3),
  )
\end{python}
and if the result is to be stored in urd:

\begin{python}
  urd.finish()
\end{python}

